/*Develop a program for the STM32F405 which receives External Interrupt and switch 1 & 2.
 For switch 1 letter 'Y' will sent serially and for switch 2 letter 'N' will sent serially.Observe the output on Live Expression.*/

#include <stdint.h>
#include <stm32f405xx.h>
#include "lcd.h"


void usart_init(void);
void write(uint8_t);
uint8_t read(void);
void exti1(void);
void exti2(void);
uint8_t res1,res2;
uint8_t flag1=0,flag2=0;

int main(void)
{
    /* Loop forever */
	usart_init();
	exti1();
	exti2();
	lcd_gpio_init();
	lcd_init();
	while(1)
	{
		    if(flag1==1)
		    {
				write('Y');
				for(unsigned int i=0;i<1000;i++);
				res1=read();
				char buf1[2]={res1,'\0'};
				lcd(0x80,0);
				lcd_string(buf1);
                flag1=0;
		    }
		    if(flag2==1)
		    {
				write('N');
				for(unsigned int i=0;i<1000;i++);
				res2=read();
				char buf2[2]={res2,'\0'};
				lcd(0x80,0);
				lcd_string(buf2);
                flag2=0;
		    }
	}

}
void usart_init()
{
	RCC->AHB1ENR|=(1<<2);// usart clock enable

	RCC->APB1ENR|=(1<<18);// usart bus enable

	GPIOC->MODER&=~(1<<20); //PC10 so 10*2=20
	GPIOC->MODER|=(1<<21);
	GPIOC->MODER&=~(1<<22);//PC11
	GPIOC->MODER|=(1<<23);

	//Alternate mode 10 AFR7 0111 for pc10
	GPIOC->AFR[1]|=(1<<8);
	GPIOC->AFR[1]|=(1<<9);
	GPIOC->AFR[1]|=(1<<10);
	GPIOC->AFR[1]&=~(1<<11);

	//alternate mode for PC11 so AF7
	GPIOC->AFR[1]|=(1<<12);
	GPIOC->AFR[1]|=(1<<13);
	GPIOC->AFR[1]|=(1<<14);
	GPIOC->AFR[1]&=~(1<<15);

	USART3->BRR=0x0683;


	USART3->CR1|=(1<<2);//TRANSMITTER ENABLE
	USART3->CR1|=(1<<3);//RECEIVER ENABLE

	USART3->CR2=0;
	USART3->CR3=0;
	USART3->CR1|=(1<<13);//usart enable
}
void write(uint8_t val)
{
	while(!(USART3->SR&(1<<7)));
	USART3->DR=val;
}
uint8_t read(void)
{
	while(!(USART3->SR&(1<<5)));
	return USART3->DR;
}
void exti1()
{
	RCC->AHB1ENR|=(1<<1);// PB7 switch for gpio B

	GPIOB->MODER&=~(3<<14);
	RCC->APB2ENR|=(1<<14);

	SYSCFG->EXTICR[1]|=(1<<12);
	SYSCFG->EXTICR[1]&=~(1<<13);
	SYSCFG->EXTICR[1]&=~(1<<14);
	SYSCFG->EXTICR[1]&=~(1<<15);

	EXTI->IMR|=(1<<7);//interrupt mask enable bcz of pb7
	EXTI->FTSR|=(1<<7);//falling triger resgiter
	NVIC_EnableIRQ(EXTI9_5_IRQn);

}
void exti2()
{
	RCC->AHB1ENR|=(1<<1); //pb3 switch for for gpio B
	GPIOB->MODER&=~(3<<6);
	RCC->APB2ENR|=(1<<14); //for PB7

	SYSCFG->EXTICR[0]|=(1<<12);
	SYSCFG->EXTICR[0]&=~(1<<13);
	SYSCFG->EXTICR[0]&=~(1<<14);
	SYSCFG->EXTICR[0]&=~(1<<15);
	EXTI->IMR|=(1<<3);
	EXTI->FTSR|=(1<<3);
	NVIC_EnableIRQ(EXTI3_IRQn);

}
void EXTI9_5_IRQHandler(void)
{
	if(EXTI->PR&(1<<7))
	{
        flag1=1;
		EXTI->PR|=(1<<7);
	}
}
void EXTI3_IRQHandler(void)
{
	if(EXTI->PR&(1<<3))
	{
        flag2=1;
		EXTI->PR|=(1<<3);
	}
}
