#include <stdint.h>
#include "stm32f405xx.h"
#include "lcd.h"

void usart3_init(void);
void usart3_write(uint8_t);
void usart3_write_string(char *str);

void usart3_init()
{
    RCC->APB1ENR |= (1 << 18); // Enable USART3 clock
    RCC->AHB1ENR |= (1 << 2);  // Enable GPIOC clock

    // PC10 (TX) alternate function
    GPIOC->MODER |= (1 << 23);
    GPIOC->MODER &= ~(1 << 22);

    // PC11 (RX) alternate function
    GPIOC->MODER |= (1 << 21);
    GPIOC->MODER &= ~(1 << 20);

    // Set PC10 and PC11 to AF7 (USART3)
    GPIOC->AFR[1] |= (7 << 8);   // PC10 = AF7
    GPIOC->AFR[1] |= (7 << 12);  // PC11 = AF7

    USART3->BRR = 0x0683;        // Baud rate 9600
    USART3->CR1 |= (1 << 2);     // RE - Receiver Enable
    USART3->CR1 |= (1 << 3);     // TE - Transmitter Enable
    USART3->CR1 |= (1 << 13);    // UE - USART Enable
}

void usart3_write(uint8_t val)
{
    while (!(USART3->SR & (1 << 7))); // Wait until TXE is set
    USART3->DR = val;
}

void usart3_write_string(char *str)
{
    while (*str)
    {
        usart3_write(*str);   // Send to USART
        lcd(*str, 1);         // Display on LCD
        str++;
    }
}

int main(void)
{
    char my_message[] = "STM32 USART"; // User-defined input

    lcd_gpio_init();
    lcd_init();
    usart3_init();

    lcd_string("Sending:");
    lcd(' ', 1); // Move to next char on same line or use custom logic

    usart3_write_string(my_message);

    while (1);
}
