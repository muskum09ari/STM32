#include "stm32f4xx.h"
#include "lcd.h"

char data[] = "DMA USART3 Send\r\n";

void dma1_stream3_init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_DMA1EN;

    DMA1_Stream3->CR &= ~DMA_SxCR_EN;
    while (DMA1_Stream3->CR & DMA_SxCR_EN);

    DMA1_Stream3->PAR = (uint32_t)&USART3->DR;
    DMA1_Stream3->M0AR = (uint32_t)data;
    DMA1_Stream3->NDTR = sizeof(data) - 1;

    DMA1_Stream3->CR &= ~(7 << 25);
    DMA1_Stream3->CR |= (4 << 25); // Channel 4 for USART3_TX

    DMA1_Stream3->CR |= DMA_SxCR_DIR_0; // Memory to peripheral
    DMA1_Stream3->CR |= DMA_SxCR_MINC;  // Memory increment
    DMA1_Stream3->CR &= ~((3 << 11) | (3 << 13)); // Byte size for mem/periph
}

void usart3_init(void)
{
    RCC->APB1ENR |= RCC_APB1ENR_USART3EN;
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOCEN;

    GPIOC->MODER |= (2 << (10 * 2)) | (2 << (11 * 2));  // Alternate function
    GPIOC->AFR[1] |= (7 << ((10 - 8) * 4)) | (7 << ((11 - 8) * 4));

    USART3->BRR = 0x0683; // 9600 baud @ 16 MHz
    USART3->CR3 |= USART_CR3_DMAT; // Enable DMA for TX
    USART3->CR1 |= USART_CR1_TE | USART_CR1_UE;
}

int main(void)
{
    usart3_init();
    dma1_stream3_init();

    DMA1_Stream3->CR |= DMA_SxCR_EN;  // Start DMA

    while (1);
}
