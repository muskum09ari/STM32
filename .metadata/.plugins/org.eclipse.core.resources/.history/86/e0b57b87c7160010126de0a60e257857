#include <stdint.h>
#include "stm32f405xx.h"
#include "lcd.h"

// Message to transmit
uint8_t message[] = "HELLO DMA";

void usart3_init(void);
void dma1_stream3_init(uint8_t *data, uint32_t len);
uint8_t usart3_read(void);

int main(void)
{
    lcd_gpio_init();
    lcd_init();

    usart3_init();

    lcd(0x80, 0);
    lcd_string("DMA TX & RX");

    // Start DMA transmit
    dma1_stream3_init(message, sizeof(message) - 1);

    for (int i = 0; i < sizeof(message) - 1; i++)
    {
        uint8_t ch = usart3_read();  // Blocking receive
        lcd(0xC0 + i, 0);            // Move to line 2 + i
        lcd_data(ch);               // Display character
    }

    while (1);
}

void usart3_init()
{
    RCC->APB1ENR |= (1 << 18);  // USART3 clock
    RCC->AHB1ENR |= (1 << 2);   // GPIOC clock

    // PC10 (TX), PC11 (RX) = Alternate function
    GPIOC->MODER &= ~((1 << 20) | (1 << 22));
    GPIOC->MODER |= ((1 << 21) | (1 << 23));

    // AF7 for USART3 (PC10 & PC11)
    GPIOC->AFR[1] |= (1 << 8) | (1 << 9) | (1 << 10);      // PC10 TX
    GPIOC->AFR[1] &= ~(1 << 11);
    GPIOC->AFR[1] |= (1 << 12) | (1 << 13) | (1 << 14);    // PC11 RX
    GPIOC->AFR[1] &= ~(1 << 15);

    USART3->BRR = 0x0683;        // Baud rate for 9600
    USART3->CR1 |= (1 << 2);     // RE (Receiver Enable)
    USART3->CR1 |= (1 << 3);     // TE (Transmitter Enable)
    USART3->CR1 |= (1 << 13);    // UE (USART Enable)
    USART3->CR3 |= (1 << 7);     // Enable DMA for TX
}

void dma1_stream3_init(uint8_t *data, uint32_t len)
{
    RCC->AHB1ENR |= (1 << 21);     // DMA1 enable

    DMA1_Stream3->CR &= ~1;        // Disable stream
    while (DMA1_Stream3->CR & 1);  // Wait till disabled

    DMA1_Stream3->PAR = (uint32_t)&USART3->DR;
    DMA1_Stream3->M0AR = (uint32_t)data;
    DMA1_Stream3->NDTR = len;

    // Channel 4 for USART3 TX
    DMA1_Stream3->CR &= ~(7 << 25);
    DMA1_Stream3->CR |= (4 << 25);

    // Direction: memory to peripheral
    DMA1_Stream3->CR |= (1 << 6);
    // Memory increment
    DMA1_Stream3->CR |= (1 << 10);
    // 8-bit data size (clear 11-14)
    DMA1_Stream3->CR &= ~((3 << 11) | (3 << 13));
    DMA1_Stream3->FCR = 0;

    DMA1_Stream3->CR |= 1;  // Enable stream
}

uint8_t usart3_read()
{
    while (!(USART3->SR & (1 << 5)));  // Wait till RXNE is set
    return USART3->DR;
}
