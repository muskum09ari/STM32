#include <stdint.h>
#include <stm32f405xx.h>



void usart3_init(void);
void dma1_stream3_init(uint8_t *data, uint32_t len);

uint8_t message[] = "HELLO";

int main(void)
{
    usart3_init();  // Initialize USART3
    dma1_stream3_init(message, sizeof(message) - 1);  // Start DMA TX

    while (1)
    {
        // Main loop can sleep or do other work. DMA handles USART TX.
    }
}

void usart3_init()
{
    // Enable USART3 clock
    RCC->APB1ENR |= (1 << 18);

    // Enable GPIOC clock (PC10 = TX, PC11 = RX)
    RCC->AHB1ENR |= (1 << 2);

    // Set PC10 and PC11 to Alternate Function mode (AF7 for USART3)
    GPIOC->MODER &= ~((3 << 20) | (3 << 22)); // Clear MODER10, MODER11
    GPIOC->MODER |= (2 << 20) | (2 << 22);    // Set to AF mode

    // Set AF7 for PC10 and PC11 (USART3) — AFRH
    GPIOC->AFR[1] &= ~((0xF << 8) | (0xF << 12));
    GPIOC->AFR[1] |= (7 << 8) | (7 << 12);

    // Baud rate 9600 @ 16MHz => BRR ≈ 0x0683
    USART3->BRR = 0x0683;

    // Enable TX and USART
    USART3->CR1 |= (1 << 3);   // TE: Transmitter enable
    USART3->CR1 |= (1 << 13);  // UE: USART enable

    // Enable DMA for USART3 TX
    USART3->CR3 |= (1 << 7);   // DMAT: DMA enable transmitter
}

void dma1_stream3_init(uint8_t *data, uint32_t len)
{
    // Enable DMA1 clock
    RCC->AHB1ENR |= (1 << 21);  // DMA1

    // Disable Stream3 before configuration
    DMA1_Stream3->CR &= ~1;
    while (DMA1_Stream3->CR & 1);  // Wait until disabled

    // Set peripheral address (USART3->DR)
    DMA1_Stream3->PAR = (uint32_t)&USART3->DR;

    // Set memory address
    DMA1_Stream3->M0AR = (uint32_t)data;

    // Set number of data items to send
    DMA1_Stream3->NDTR = len;

    // Channel 4 selection
    DMA1_Stream3->CR &= ~(7 << 25);
    DMA1_Stream3->CR |= (4 << 25);

    // Memory-to-peripheral direction
    DMA1_Stream3->CR |= (1 << 6);

    // Memory increment
    DMA1_Stream3->CR |= (1 << 10);

    // Peripheral and memory data size = byte (00)
    DMA1_Stream3->CR &= ~((3 << 11) | (3 << 13));

    // Direct mode (disable FIFO)
    DMA1_Stream3->FCR = 0;

    // Enable the DMA stream
    DMA1_Stream3->CR |= 1;
}
