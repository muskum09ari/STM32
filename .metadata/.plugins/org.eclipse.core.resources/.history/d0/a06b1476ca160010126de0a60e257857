#include <stdint.h>
#include "stm32f405xx.h"
#include "lcd.h"

uint8_t message[] = "Muskan kumari ";
uint8_t res;

void usart3_init(void);
void dma1_stream3_init(uint8_t *data, uint32_t len);
void delay(void);

int main(void)
{
    lcd_gpio_init(); // Enable LCD GPIO
    lcd_init();      // Initialize LCD
    usart3_init();   // Initialize USART3
    dma1_stream3_init(message, sizeof(message) - 1);  // DMA TX

    lcd(0x80, 0);
    lcd_string("Rcv: ");

    for (int i = 0; i < sizeof(message) - 1; i++)
    {
        while (!(USART3->SR & (1 << 5)));  // Wait until RXNE
        res = USART3->DR;
        char buffer[2] = {res, '\0'};
        lcd_string(buffer);
        delay();  // Optional delay for LCD visibility
    }

    while (1);
}

void usart3_init()
{
    RCC->AHB1ENR |= (1 << 2);    // GPIOC clock
    RCC->APB1ENR |= (1 << 18);   // USART3 clock

    // PC10 (TX) and PC11 (RX) as AF7
    GPIOC->MODER &= ~((3 << 20) | (3 << 22));
    GPIOC->MODER |= (2 << 20) | (2 << 22);

    GPIOC->AFR[1] |= (7 << 8);   // AF7 for PC10
    GPIOC->AFR[1] |= (7 << 12);  // AF7 for PC11

    USART3->BRR = 0x0683;  // 9600 @ 16 MHz
    USART3->CR1 |= (1 << 3) | (1 << 2); // TE + RE
    USART3->CR1 |= (1 << 13);          // UE
    USART3->CR3 |= (1 << 7);           // DMA TX Enable
}

void dma1_stream3_init(uint8_t *data, uint32_t len)
{
    RCC->AHB1ENR |= (1 << 21);  // DMA1 clock enable

    DMA1_Stream3->CR &= ~1;  // Disable DMA stream
    while (DMA1_Stream3->CR & 1);  // Wait

    DMA1_Stream3->PAR = (uint32_t)&USART3->DR;
    DMA1_Stream3->M0AR = (uint32_t)data;
    DMA1_Stream3->NDTR = len;

    DMA1_Stream3->CR &= ~(7 << 25); // Clear channel selection
    DMA1_Stream3->CR |= (4 << 25);  // Channel 4 for USART3_TX

    DMA1_Stream3->CR |= (1 << 6);   // DIR: Memory-to-peripheral
    DMA1_Stream3->CR |= (1 << 10);  // MINC
    DMA1_Stream3->CR &= ~((3 << 11) | (3 << 13)); // 8-bit size

    DMA1_Stream3->FCR = 0;          // Direct mode
    DMA1_Stream3->CR |= 1;          // Enable stream
}

void delay()
{
    for (volatile int i = 0; i < 500000; i++);
}
