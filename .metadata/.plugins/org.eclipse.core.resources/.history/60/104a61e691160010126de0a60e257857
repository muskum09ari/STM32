#include <stdint.h>
#include <stm32f405xx.h>
#if !defined(__SOFT_FP__) && defined(__ARM_FP)
  //#warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

void adc_init(void);
void adc_conversion(void);
uint32_t val;
int main(void)
{
    /* Loop forever */
	RCC->AHB1ENR|=(1<<2);   //enable rcc clock for port-c
	RCC->AHB1ENR|=(1<<1);   //enable rcc clock for port-b
	GPIOC->MODER|=(1<<12);  //enable gpioc moder led-1 pc-6
	GPIOC->MODER&=~(1<<13);
	GPIOB->MODER|=(1<<26);  //enable gpiob moder led-2 pb-13
	GPIOB->MODER&=~(1<<27);
	GPIOB->MODER|=(1<<28);  //enable gpiob moder led-3 pb-14
	GPIOB->MODER&=~(1<<29);
	GPIOB->MODER|=(1<<30);  //enable gpiob moder led-4 pb-15
	GPIOB->MODER&=~(1<<31);
	GPIOC->ODR|=(1<<6);
	GPIOB->ODR|=(1<<13);
	GPIOB->ODR|=(1<<14);
	GPIOB->ODR|=(1<<15);
	adc_init();
	while(1)
	{
		adc_conversion();
		if(val==0.25*4095)
		{
			GPIOC->ODR&=~(1<<6);
			GPIOB->ODR|=(1<<13);
			GPIOB->ODR|=(1<<14);
			GPIOB->ODR|=(1<<15);
		}
		else if(val==0.5*4095)
		{
			GPIOB->ODR&=~(1<<13);
			GPIOC->ODR|=(1<<6);
			GPIOB->ODR|=(1<<14);
			GPIOB->ODR|=(1<<15);
		}
		else if(val==0.75*4095)
		{
			GPIOB->ODR&=~(1<<14);
			GPIOB->ODR|=(1<<13);
			GPIOC->ODR|=(1<<6);
			GPIOB->ODR|=(1<<15);
		}
		else if(val==4095)
		{
			GPIOC->ODR&=~(1<<6);
			GPIOB->ODR&=~(1<<13);
			GPIOB->ODR&=~(1<<14);
			GPIOB->ODR&=~(1<<15);
		}
	}
	//for(;;);
}
void adc_init()
{
	RCC->AHB1ENR|=(1<<2);
	RCC->APB2ENR|=(1<<8);
	GPIOC->MODER|=(1<<2);
	GPIOC->MODER|=(1<<3);
	ADC1->CR2=0;
	ADC1->SQR1&=~(1<<20);
	ADC1->SQR1&=~(1<<21);
	ADC1->SQR1&=~(1<<22);
	ADC1->SQR1&=~(1<<23);

	ADC1->SQR3=11;
	ADC1->CR1|=(1<<8); //scan mode enable
	ADC1->CR1=11;
	ADC1->CR2|=(1<<0);
}
void adc_conversion()
{
	ADC1->CR2|=(1<<30);
	while(!(ADC1->SR&(1<<1)));
	val=ADC1->DR;
}
