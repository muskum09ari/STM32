#include <stdint.h>
#include <stm32f405xx.h>
void usart3_init(void);
uint8_t usart_read(void);
void usart_write(uint8_t);
uint8_t res=0;
char buffer[40];
int main(void)
{
	lcd_gpio_init();
	lcd_init();
	usart3_init();

	NVIC_EnableIRQ(USART3_IRQn);
	while(1)
	{
		usart_write('M');
		for(int i=0;i<100;i++){};
		lcd(0x80,0);
		//lcd(res,1);
		char buffer[2] = {res, '\0'};
		lcd_string(buffer);
	}
	//for(;;);
}
void usart3_init()
{
	 RCC->APB1ENR |= (1 << 18); // Enable USART3 clock
	    RCC->AHB1ENR |= (1 << 2);  // Enable GPIOC clock

	    // PC10 (TX) alternate function
	    GPIOC->MODER |= (1 << 23);
	    GPIOC->MODER &= ~(1 << 22);

	    // PC11 (RX) alternate function
	    GPIOC->MODER |= (1 << 21);
	    GPIOC->MODER &= ~(1 << 20);

	GPIOC->AFR[1]|=(1<<8);  //enable gpio afr values for pc-10
	GPIOC->AFR[1]|=(1<<9);
	GPIOC->AFR[1]|=(1<<10);
	GPIOC->AFR[1]&=~(1<<11);
	GPIOC->AFR[1]|=(1<<12);  //enable gpio afr values for pc-11
	GPIOC->AFR[1]|=(1<<13);
	GPIOC->AFR[1]|=(1<<14);
	GPIOC->AFR[1]&=~(1<<15);

	USART3->BRR=0x0683;
	USART3->CR1|=(1<<2);
	USART3->CR1|=(1<<3);

	USART3->CR2=0;
	USART3->CR3=0;
	USART3->CR1|=(1<<13);

	USART3->CR1|=(1<<5); //interrupt enable for bit no. 5 rxne of cr1
}

void usart_write(uint8_t val)
{
	while(!(USART3->SR&=~(1<<7)));
	USART3->DR=val;
}
void USART3_IRQHandler(void)
{
	if(USART3->SR&(1<<5))
	{
		res=USART3->DR;
	}
}
