#include <stdint.h>
#include "stm32f405xx.h"
#include "lcd.h"

uint8_t message[] = "Muskan kumari ";
uint8_t res;

void usart3_init(void);
void dma1_stream3_init(uint8_t *data, uint32_t len);
void delay(void);

int main(void)
{
    lcd_gpio_init();
    lcd_init();

    usart3_init();
    dma1_stream3_init(message, sizeof(message) - 1);

    lcd(0x80, 0);
    lcd_string("TX via DMA");

    delay(); // wait for transmission to finish

    lcd(0xC0, 0);
    lcd_string("RX: ");

    for (int i = 0; i < sizeof(message) - 1; i++)
    {
        while (!(USART3->SR & (1 << 5))); // Wait for RXNE
        res = USART3->DR;
        char buffer[2] = {res, '\0'};
        lcd_string(buffer);
        delay(); // to allow display timing
    }

    while (1);
}

void usart3_init()
{
    RCC->APB1ENR |= (1 << 18);  // USART3 clock
    RCC->AHB1ENR |= (1 << 2);   // GPIOC clock

    // PC10 (TX), PC11 (RX)
    GPIOC->MODER &= ~((1 << 20) | (1 << 22));
    GPIOC->MODER |= ((1 << 21) | (1 << 23));

    GPIOC->AFR[1] |= (7 << 8);  // AF7 for PC10
    GPIOC->AFR[1] |= (7 << 12); // AF7 for PC11

    USART3->BRR = 0x0683;               // 9600 baud @16MHz
    USART3->CR1 |= (1 << 3) | (1 << 2); // TE, RE
    USART3->CR1 |= (1 << 13);          // UE
    USART3->CR3 |= (1 << 7);           // DMAT
}

void dma1_stream3_init(uint8_t *data, uint32_t len)
{
    RCC->AHB1ENR |= (1 << 21); // DMA1 enable

    DMA1_Stream3->CR &= ~1;
    while (DMA1_Stream3->CR & 1);

    DMA1_Stream3->PAR = (uint32_t)&USART3->DR;
    DMA1_Stream3->M0AR = (uint32_t)data;
    DMA1_Stream3->NDTR = len;

    DMA1_Stream3->CR &= ~(7 << 25); // clear channel select
    DMA1_Stream3->CR |= (4 << 25);  // channel 4

    DMA1_Stream3->CR |= (1 << 6);  // mem-to-periph
    DMA1_Stream3->CR |= (1 << 10); // MINC
    DMA1_Stream3->CR &= ~((3 << 11) | (3 << 13)); // 8-bit transfer

    DMA1_Stream3->FCR = 0;
    DMA1_Stream3->CR |= 1; // enable stream
}

void delay()
{
    for (volatile int i = 0; i < 100000; i++);
}
